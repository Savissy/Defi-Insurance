import {
  Lucid,
  Blockfrost,
  Constr,
  Data,
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

/* =====================================================
   CONFIG
===================================================== */
const BLOCKFROST_URL = "https://cardano-preprod.blockfrost.io/api/v0";
const BLOCKFROST_KEY = "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip";
const NETWORK = "Preprod";

// IMPORTANT: DO NOT keep secrets in frontend. Use backend or short-lived token.
const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI1ODI1MGRjNi1mNTY2LTQwY2YtYjhhYy1hNzVjY2IyMzBiYWUiLCJlbWFpbCI6InV6b3Vrd3VzYXZpb3VyQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiJiMWY3NzRjZWEyNGRjZTUwZWI1ZCIsInNjb3BlZEtleVNlY3JldCI6IjMyYjYxMzFhNzhiY2I0ZDFjNzgzMDEzZTdmMDRkODBhOTI4YmFiMzdhYTRhMGRiYTdlYTk5N2Y0Mjc4OWE4OTMiLCJleHAiOjE4MDI1MDY3MjZ9.ziuza2AC5jTOM-7eU6O4OChDYQNr-ULZL-d1t80LmeY";

/* =====================================================
   POOL SHARES (MINTING POLICY)
===================================================== */
const SHARE_POLICY_CBOR = "59090d01000033233223322323232323232323232323232323232323232322223232533532323253355335333553009120013232123300122333500522002002001002350012200112330012253350021020100101d23535350012200122220042233500220202333573466e3c004030084080d5400488888888888803040744cd5ce24916706f6f6c207574786f206e6f7420636f6e73756d65640001c153355335333573466e1cc8c8c8c00400cc8004d5408888cd400520002235002225335333573466e3c00801c0940904c08c0044c01800cd400c88cccd40048c98c8074cd5ce2481024c680001e200123263201d3357389201024c680001e23263201d3357389201024c680001e355001222222222222008480000740704070407440744cd5ce24917696e76616c6964207368617265206d696e742f6275726e0001c101c135001220023333573466e1cd55cea801a4000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd405c060d5d0a80619a80b80c1aba1500b33501701935742a014666aa036eb94068d5d0a804999aa80dbae501a35742a01066a02e0406ae85401cccd5406c085d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40add69aba15002302c357426ae8940088c98c80b8cd5ce01701781609aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a815bad35742a00460586ae84d5d1280111931901719ab9c02e02f02c135573ca00226ea8004d5d09aba2500223263202a33573805405605026aae7940044dd50009aba1500533501775c6ae854010ccd5406c0748004d5d0a801999aa80dbae200135742a004603e6ae84d5d1280111931901319ab9c026027024135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a006601e6ae84d5d1280191931900c19ab9c0180190163333573466e1cd55ce9baa0044800080608c98c805ccd5ce00b80c00a880b8b09aab9e500113754002640026aa02e4422444a66a00226a00644002442666a00a440046008004666aa600e2400200a0080022464460046eb0004c8004d5405c88cccd55cf8009280c919a80c18021aba1002300335744004026464646666ae68cdc39aab9d5002480008cc8848cc00400c008c028d5d0a80118029aba135744a004464c6402466ae7004804c0404d55cf280089baa0012323232323333573466e1cd55cea8022400046666444424666600200a0080060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008c04cd5d0a80119a8068091aba135744a004464c6402e66ae7005c0600544d55cf280089baa00135742a008666aa010eb9401cd5d0a8019919191999ab9a3370ea0029002119091118010021aba135573ca00646666ae68cdc3a80124004464244460020086eb8d5d09aab9e500423333573466e1d400d20002122200323263201933573803203402e02c02a26aae7540044dd50009aba1500233500975c6ae84d5d1280111931900999ab9c013014011135744a00226ae8940044d55cf280089baa0011335500175ceb44488c88c008dd5800990009aa80a11191999aab9f00225017233501633221233001003002300635573aa004600a6aae794008c010d5d100180889aba100112232323333573466e1d4005200023212230020033005357426aae79400c8cccd5cd19b8750024800884880048c98c8040cd5ce00800880700689aab9d500113754002464646666ae68cdc3a800a400c46424444600800a600e6ae84d55cf280191999ab9a3370ea004900211909111180100298049aba135573ca00846666ae68cdc3a801a400446424444600200a600e6ae84d55cf280291999ab9a3370ea00890001190911118018029bae357426aae7940188c98c8040cd5ce00800880700680600589aab9d500113754002464646666ae68cdc39aab9d5002480008cc8848cc00400c008c014d5d0a8011bad357426ae8940088c98c8030cd5ce00600680509aab9e5001137540024646666ae68cdc39aab9d5001480008dd71aba135573ca004464c6401466ae7002802c0204dd5000919191919191999ab9a3370ea002900610911111100191999ab9a3370ea004900510911111100211999ab9a3370ea00690041199109111111198008048041bae35742a00a6eb4d5d09aba2500523333573466e1d40112006233221222222233002009008375c6ae85401cdd71aba135744a00e46666ae68cdc3a802a400846644244444446600c01201060186ae854024dd71aba135744a01246666ae68cdc3a8032400446424444444600e010601a6ae84d55cf280591999ab9a3370ea00e900011909111111180280418071aba135573ca018464c6402666ae7004c05004404003c03803403002c4d55cea80209aab9e5003135573ca00426aae7940044dd50009191919191999ab9a3370ea002900111999110911998008028020019bad35742a0086eb4d5d0a8019bad357426ae89400c8cccd5cd19b875002480008c8488c00800cc020d5d09aab9e500623263200c33573801801a01401226aae75400c4d5d1280089aab9e500113754002464646666ae68cdc3a800a400446424460020066eb8d5d09aab9e500323333573466e1d400920002321223002003375c6ae84d55cf280211931900499ab9c00900a007006135573aa00226ea8004488c8c8cccd5cd19b87500148010848880048cccd5cd19b875002480088c84888c00c010c018d5d09aab9e500423333573466e1d400d20002122200223263200a33573801401601000e00c26aae7540044dd50009191999ab9a3370ea0029001100491999ab9a3370ea0049000100491931900319ab9c006007004003135573a6ea80052649103505431001200132001355005223350014800088d4008894cd4ccd5cd19b8f002488109504f4f4c534841524500008007100113006003122002122001112200212212233001004003112323001001223300330020020014891c5570db63cb267f9102d317ea23ae59d350d64ba6dbd70b87e7e99d3e0001";
const sharePolicy = { type: "PlutusV2", script: SHARE_POLICY_CBOR };

// TokenName "POOLSHARE" hex
const SHARE_TN_HEX = "504f4f4c5348415245"; // POOLSHARE
export let SHARE_POLICY_ID;
export let SHARE_UNIT;

/* =====================================================
   MEMBERSHIP POLICY (SOULBOUND)
===================================================== */
export let MEMBERSHIP_POLICY_ID;
const MEMBERSHIP_POLICY_CBOR = "59092501000032323233223232323232323232323322323322323232323232323232223232533532325335533553353008355001222222222222008101e22135002222533500415335333573466e3c00cd401c88cccd40048c98c8098cd5ce2481024c680002920012326320263357389201024c68000292326320263357389201024c680002902402315335333573466e1c005200202402315335333573466e3c009221000240231023102410231023221025101f1335738921196d757374206d696e742065786163746c79206f6e65204e46540001e1533553353008355001222222222222008101e22135002222533500413235001222222222222533533355301912001321233001225335002210031001002502525335333573466e3c0400040c80c44d409c00454098010840c840c14018884094407c4cd5ce24811d6d757374206265207369676e656420627920746f6b656e206f776e65720001e101e135001220023333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4060064d5d0a80619a80c00c9aba1500b33501801a35742a014666aa038eb9406cd5d0a804999aa80e3ae501b35742a01066a03004a6ae85401cccd54070099d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40c1d69aba150023031357426ae8940088c98c80cccd5ce01a81b01889aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8183ad35742a00460626ae84d5d1280111931901999ab9c035036031135573ca00226ea8004d5d09aba2500223263202f33573806206405a26aae7940044dd50009aba1500533501875c6ae854010ccd540700888004d5d0a801999aa80e3ae200135742a00460486ae84d5d1280111931901599ab9c02d02e029135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00460286ae84d5d1280111931900e99ab9c01f02001b101f16135573ca00226ea8004c8004d5406c88448894cd40044d400c88004884ccd401488008c010008ccd54c01c480040140100048cc0094028004c8004d540648894cd40044008884d400888cc01cccc02000801800400cc8004d5406088894cd40044008884d4008894cd4ccd5cd19b87001480000740704ccc02001c01800c4ccc02001ccd403848ccc00402000c00801800c48c88c008dd6000990009aa80c111999aab9f0012500a233500930043574200460066ae880080648c8c8cccd5cd19b8735573aa004900011991091980080180118071aba150023005357426ae8940088c98c8058cd5ce00c00c80a09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180b9aba1500233500f016357426ae8940088c98c806ccd5ce00e80f00c89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403a66ae7007c08006c0680644d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201733573803203402a26ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355015223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301713574200222440042442446600200800624464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900919ab9c01401501000f135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01201300e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00e00f00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00600680409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a80b00880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae7003803c0280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801601800e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7003003402001c0184d55cea80089baa0012323333573466e1d40052002200623333573466e1d40092000200623263200633573801001200800626aae74dd5000a4c2440042440029210350543100120011123230010012233003300200200101";
const membershipPolicy = { type: "PlutusV2", script: MEMBERSHIP_POLICY_CBOR };

/* =====================================================
   INSURANCE + POOL VALIDATORS (CBOR)
===================================================== */
const INSURANCE_VALIDATOR_CBOR = "590da9010000323232323232332232323232323232323322323233223232323232323232323232323232323322323232232323232323223232232325335323232323232533335005153355335333573466e20c8cccd54c07048004c8cd408088ccd408400c004008d4078004cd407c888c00cc008004800488cdc0000a400400290001a8031111110019a80311111100301b01b881b899ab9c4901117468726573686f6c64206e6f74206d65740003615335333573466e20ccc050ccd54c0584800488cd54c070480048d400488cd540bc008cd54c07c480048d400488cd540c8008ccd40048cc1152000001223304600200123304500148000004cd54c070480048d400488cd540bc008ccd40048cd54c080480048d400488cd540cc008d5408400400488ccd55407009c0080048cd54c080480048d400488cd540cc008d54080004004ccd55405c08800800540a4c8c8d4004888888888888ccd54c0904800488d40088888d401088cd400894cd4ccd5cd19b8f01700104e04d133503f00600810082008503700a5004350062222220050220223500622222200403603710371335738920111636c61696d616e74206e6f74207061696400036103615335500110371335738921136d656d626572736869702072657175697265640003621533553355002103813357389201136d656d626572736869702072657175697265640003715335333573466e2400520000370381038133573892010e696e76616c696420616d6f756e7400037103715335533533355301b1200135019501f3020500235006222222003103610371037133573892010b646f75626c6520766f7465000361533532323500222222222222253353335530281200133502b225335002210031001503925335333573466e3c0380041141104d40ec004540e801084114410d4009400854cd4c8c8ccd54c07048004d406940808d4d4d400488004888801088cd40088cc09400401480ecd4008888888888888031400940084c8c94cd4ccd5cd19b8733301535002222222222222008022001480000e00dc4ccd54c07048004d406940808ccd5cd19b883330163535001220012222003023002480080e00e4d400888888888888803040dd4009400840d440d454cd4d540048888888888880104c0dd2622153350011002221303b4984d400488008cccd5cd19b8735573aa0089000119910919800801801191919191919191919191919191999ab9a3370e6aae754031200023333333333332222222222221233333333333300100d00c00b00a00900800700600500400300233502e02f35742a01866a05c05e6ae85402ccd40b80c0d5d0a805199aa8193ae503135742a012666aa064eb940c4d5d0a80419a81701e1aba150073335503203d75a6ae854018c8c8c8cccd5cd19b8735573aa00490001199109198008018011919191999ab9a3370e6aae754009200023322123300100300233504775a6ae854008c120d5d09aba2500223263204e33573809609c09826aae7940044dd50009aba150023232323333573466e1cd55cea8012400046644246600200600466a08eeb4d5d0a80118241aba135744a004464c6409c66ae7012c1381304d55cf280089baa001357426ae8940088c98c8128cd5ce02382502409aab9e5001137540026ae854014cd40b9d71aba1500433355032039200135742a006666aa064eb88004d5d0a801181d9aba135744a004464c6408c66ae7010c1181104d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a80218159aba135744a008464c6407066ae700d40e00d8cccd5cd19b875005480188488880108cccd5cd19b875006480108488880048cccd5cd19b875007480088c848888c008014dd69aba135573ca01246666ae68cdc3a80424000424444006464c6407466ae700dc0e80e00dc0d80d4cccd5cd19b8735573aa01890001199999911111091999998008038030028020018011bad35742a0186eb8d5d0a8059bad35742a01466a03ceb8d5d0a8049919191999ab9a3370e6aae754009200023355029375c6ae854008dd71aba135744a004464c6407466ae700dc0e80e04d55cf280089baa00135742a01060606ae84d5d1280411931901b19ab9c033036034103516135573ca00226ea80044d55cea80089baa001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004888c8c8c004014c8004d540b488cd400520002235002225335333573466e3c0080240b40b04c01c0044c01800cc8004d540b088cd400520002235002225335333573466e3c00801c0b00ac40044c01800c444888ccd54c010480054058cd54c020480048d400488cd5406c008d54024004ccd54c0104800488d4008894cd4ccd54c03448004d402d40448d400488cc028008014018400c4cd406801000d405c004cd54c020480048d400488c8cd5407000cc004014c8004d540b8894cd40044d5402800c884d4008894cd4cc03000802044888cc0080280104c01800c008c8004d5409c88448894cd40044008884cc014008ccd54c01c480040140100044484888c00c0104484888c00401048cd401888ccd400c88008008004d400488004c8004d5408c8844894cd40045404c884cd4050c010008cd54c01848004010004c8004d5408888448894cd40044d401800c884ccd4024014c010008ccd54c01c4800401401000448d40048800448d40048800848848cc00400c008448cc004894cd4008406c400406088ccd5cd19b8f0020010190184894033663666353636363766316531633638333331366539663536313663336439333833663830343530353737363463313033613034326336666263343764313331004881001232230023758002640026aa036446666aae7c004940288cd4024c010d5d080118019aba200201b232323333573466e1cd55cea80124000466442466002006004601e6ae854008c014d5d09aba2500223263201b33573803003603226aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea8012400046644246600200600460306ae854008cd404005cd5d09aba2500223263202033573803a04003c26aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931901119ab9c01f02202001f01e135573aa00226ea8004d5d0a80119a8063ae357426ae8940088c98c8070cd5ce00c80e00d09aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5406088c8cccd55cf80112804119a80399aa80498031aab9d5002300535573ca00460086ae8800c0644d5d08008891001091091198008020018891091980080180109119191999ab9a3370ea002900011a80398029aba135573ca00646666ae68cdc3a801240044a00e464c6402c66ae7004c05805004c4d55cea80089baa0011212230020031122001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6402866ae7004405004804404003c4d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6402066ae700340400384d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263200e33573801601c01826ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201733573802802e02a02802602402202001e26aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900819ab9c00d01000e00d135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c8034cd5ce00500680580509aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900719ab9c00b00e00c00b00a135573aa00226ea80048c8cccd5cd19b8750014800880148cccd5cd19b8750024800080148c98c8028cd5ce00380500400389aab9d375400224400424400292103505431002326320033357389211b65786163746c79206f6e65207369676e6572207265717569726564000034984800488cdc00010008891918008009119801980100100081";
const insuranceValidator = { type: "PlutusV2", script: INSURANCE_VALIDATOR_CBOR };

const POOL_VALIDATOR_CBOR = "5911e2010000323232323322323322323233223232323232323232323232323232323232323232323232323233223232223232232325335323232323232323232325333500915335333573466e20c8c8cccd54c07848004cd407c888c00cc0080048004894cd4ccd54c08048004d40694070c0740080104cdc0000a4004200200290001aa8041111111111110021a80511110021a80511110018178180818099ab9c49011e706f6f6c3a20696e73756666696369656e74207369676e61746f726965730002f153355335333573466e254019200002f030103013357389211f706f6f6c3a206d757374206d696e7420706f736974697665207368617265730002f153355335333573466e1cd540088888004cdc01a8051111000a8030180178818099ab9c490129706f6f6c3a206d75737420696e63726561736520746f74616c53686172657320636f72726563746c790002f153355001103013357389211a706f6f6c3a206d75737420707265736572766520636f6e6669670002f102f102f232153355335333573466e240092000031032103213357389211e706f6f6c3a206275726e6564536861726573206d757374206265203e203000031153355335333573466e1d4020cdc0a40000040640622064266ae712411c706f6f6c3a206d757374206275726e2065786163742073686172657300031153355335333573466e24008d403088880040c80c440c84cd5ce24923706f6f6c3a207769746864726177206578636565647320746f74616c2073686172657300031153355335323232333553021120013501b501d23535350012200122220042233500225335330220010061333573466e20d401488ccc094d4d401888004888800c0080040240e00e440e080e0d400c888888888888030d403888880094021402440c84cd5ce24925706f6f6c3a207369676e6572206d7573742070726f7669646520736861726520696e70757400031153355335333573466e20ccc070c8c8ccd54c05c4800488cd54c074480048d400488cd540f8008cd54c080480048d400488cd54104008ccd40048cc11d2000001223304800200123304700148000004cd54c074480048d400488cd540f8008ccd40048cd54c084480048d400488cd54108008d5408800400488ccd5540740900080048cd54c084480048d400488cd54108008d54084004004ccd55406007c00800540e0d4008888888888888ccd54c08c4800488d40088888d401088cd400894cd4ccd5cd19b8f016001049048133504c00600810082008504400a50085009022022500103103210321335738920122706f6f6c3a206d75737420706179207369676e65722065787065637465642041444100031153355335333573466e1cccc070d54014888800c088088cdc0a80328008190188819099ab9c49012a706f6f6c3a20706f6f6c206f757470757420414441206d757374206d617463682072656d61696e64657200031153355335333573466e1cd540108888004cdc09a80611110008010190188819099ab9c49129706f6f6c3a206d75737420646563726561736520746f74616c53686172657320636f72726563746c7900031153355003103213357389211a706f6f6c3a206d75737420707265736572766520636f6e6669670003110311031103110311031103110311323370666e080094018d403088880054cd54cd4ccd5cd19b893500b2222001480000c00c440c44cd5ce24917706f6f6c3a207a65726f20746f74616c207368617265730003010301030153353335302012001018355001222200435009222200415335333573466e1cd54004888800cd4024888800c0bc0b84c8c8d400888d400c894cd4ccd5cd19b8f00400203503413301e00300110343500a22220023550012222002102e102e132533353500122220021326320383357389211a706f6f6c3a206d697373696e67206f757470757420646174756d0003821301e001213263203933573892011b706f6f6c3a20657870656374656420696e6c696e6520646174756d0003950011325335001130304988854cd40044008884c0d126533530180052135001223500122223500c2235002222222222222333553025120012235002222253353501822350062232335005233500425335333573466e3c00800413c1385400c413881388cd4010813894cd4ccd5cd19b8f00200104f04e15003104e153350032153350022133500223350022335002233500223303b00200120512335002205123303b00200122205122233500420512225335333573466e1c01800c15014c54cd4ccd5cd19b870050020540531333573466e1c01000415014c414c414c413054cd40048413041304cd412c018014401541180284c98c80d8cd5ce2481024c660003613330163553353017004213500122001132632035335738920117706f6f6c3a206d697373696e67206f776e20696e70757400035222200301c01c132533535001222222222222004132632035335738920122706f6f6c3a206174206c65617374206f6e65207369676e657220726571756972656400035221002500213535004222200222333016355003222222222222008002001135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40980a4d5d0a80619a8130149aba1500b33502602a35742a014666aa058eb940acd5d0a804999aa8163ae502b35742a01066a04c0626ae85401cccd540b00c9d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40f1d69aba15002303d357426ae8940088c98c8120cd5ce02002402309aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a81e3ad35742a004607a6ae84d5d1280111931902419ab9c040048046135573ca00226ea8004d5d09aba2500223263204433573807808808426aae7940044dd50009aba1500533502675c6ae854010ccd540b00b88004d5d0a801999aa8163ae200135742a00460606ae84d5d1280111931902019ab9c03804003e135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860406ae84d5d1280211931901919ab9c02a0320303333573466e1d401520042122200323333573466e1d4019200223212223001004375a6ae84d55cf280411999ab9a3370ea00e90001091100111931901999ab9c02b03303103002f3014007102f16135573ca00226ea80044d55cea80089baa0011112223335530041200150243355300812001235001223355029002355009001333553004120012235002225335333553011120013500b500d235001223300a00200500610031335028004003502500133553008120012350012232335502a00330010053200135502f225335001135500a003221350022253353300c002008112223300200a00413006003002320013550282211222533500110022213300500233355300712001005004001112122230030041121222300100412335008223335003220020020013500122001320013550242211225335001150212213350223004002335530061200100400111233001225335002101b100101822333573466e3c008004064060888c8c8c004014c8004d5409488cd400520002235002225335333573466e3c00802408007c4c01c0044c01800cc8004d5409088cd400520002235002225335333573466e3c00801c07c07840044c01800c8d400488d4008888888888888cccd4034940ac940ac940ac8ccd54c04448004cd4048894cd40088400c400540ac8d4004894cd54cd4ccd5cd19b8f350022200235004220020280271333573466e1cd400888004d4010880040a009c409c4d40bc00c540b8034c8004d5407c88448894cd40044d400c88004884ccd401488008c010008ccd54c01c4800401401000448848cc00400c0088c8c8c8c8cccd5cd19b8735573aa008900011999911109199980080280200180119a803bae35742a0086eb4d5d0a8019919191999ab9a3370e6aae754009200023355021375c6ae854008dd71aba135744a004464c6404a66ae7007409408c4d55cf280089baa00135742a0046eb4d5d09aba2500223263202133573803204203e26ae8940044d5d1280089aab9e5001137540022464460046eb0004c8004d5407488cccd55cf8009280c919a80c18021aba100230033574400403a9101003200135501a221222533500215335001101422101522153350031015221533533007004002133353009120010070030011017232323333573466e1cd55cea8012400046644246600200600460146ae854008c014d5d09aba2500223263201b33573802603603226aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea8012400046644246600200600460266ae854008cd4034048d5d09aba2500223263202033573803004003c26aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931901119ab9c01a02202001f01e135573aa00226ea8004d5d0a80119a804bae357426ae8940088c98c8070cd5ce00a00e00d09aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5406088c8cccd55cf8011280a919a80a19aa80b18031aab9d5002300535573ca00460086ae8800c0644d5d080089119191999ab9a3370ea002900011a80b18029aba135573ca00646666ae68cdc3a801240044a02c464c6403266ae7004406405c0584d55cea80089baa001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6403266ae7004406405c0580540504d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6402a66ae7003405404c4d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263201333573801602602226ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201c33573802803803403203002e02c02a02826aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900a99ab9c00d015013012135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c8048cd5ce00500900800789aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900999ab9c00b01301101000f135573aa00226ea80048c8cccd5cd19b8750014800880148cccd5cd19b8750024800080148c98c803ccd5ce00380780680609aab9d375400224400424400292103505431002326320083357389212c706f6f6c3a2065787065637465642065786163746c79206f6e6520636f6e74696e75696e67206f7574707574000081122002122122330010040031122123300100300212122300200311220014984800488cdc00010008891918008009119801980100100081";
const poolValidator = { type: "PlutusV2", script: POOL_VALIDATOR_CBOR };

/* =====================================================
   CLAIM DOC POLICY + DOCVAULT VALIDATOR
===================================================== */

// Your existing “doc policy” cbor (mints 1 NFT).
const DOC_POLICY_CBOR = "590a1601000032323232332233223232323232323232323232323232323232322232325335323232325335533553355002101d2213500222253350041533532333573466e3c01000409008d40184ccd5cd19b870014800808c088408888409040784cd5ce249216d757374206d696e742065786163746c79206f6e6520696e766f696365204e46540001d1533553355335355003222222222222004101d22153350011020221021101e133573892011c697373756572206d757374207369676e207472616e73616374696f6e0001d153355335333573466e1ccccd54c0244800448cc004888c00cc0080048004894cd4d4d4008888801088cd400880888ccd5cd19b87323232323230010053200135502b223350014800088d4008894cd4ccd5cd19b8f00200902d02c13007001130060033200135502a223350014800088d4008894cd4ccd5cd19b8f00200702c02b1001130060035335500913026498884d40088894cd40104008884c0b52650073500522220034800808c0884cdc0000a400420026aa00644444444444401490002400403c03a203c266ae712412f4e4654206d757374206265206c6f636b656420696e2065786163746c79206f6e6520736372697074206f75747075740001d101e133573892011f4e4654206e6f74206c6f636b656420617420736372697074206f75747075740001d101d101d13500322333350012326320233357389201024c680002320012326320233357389201024c68000232326320233357389201024c680002313233018501b001355001222222222222008135001220023333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4054058d5d0a80619a80a80b1aba1500b33501501735742a014666aa032eb94060d5d0a804999aa80cbae501835742a01066a02a03c6ae85401cccd5406407dd69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a5d69aba15002302a357426ae8940088c98c80d0cd5ce01581a01909aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a814bad35742a00460546ae84d5d1280111931901a19ab9c02b034032135573ca00226ea8004d5d09aba2500223263203033573804e06005c26aae7940044dd50009aba1500533501575c6ae854010ccd5406406c8004d5d0a801999aa80cbae200135742a004603a6ae84d5d1280111931901619ab9c02302c02a135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004601a6ae84d5d1280111931900f19ab9c01501e01c101d16135573ca00226ea8004c8004d5406488448894cd40044d400c88004884ccd401488008c010008ccd54c01c4800401401000448c88c008dd6000990009aa80c911999aab9f00125016233501530043574200460066ae880080688c8c8cccd5cd19b8735573aa004900011991091980080180118051aba150023005357426ae8940088c98c8068cd5ce00880d00c09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa004900011991091980080180118099aba1500233500d012357426ae8940088c98c807ccd5ce00b00f80e89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404266ae7006008407c0780744d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201b33573802403603226ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355016223233335573e0044a028466a02666442466002006004600c6aae754008c014d55cf280118021aba200301813574200224464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900c19ab9c00f018016015135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900c19ab9c00f018016015014013135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900a19ab9c00b014012135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8048cd5ce00480900809baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c806ccd5ce00900d80c80c00b80b00a80a00989aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6402866ae7002c0500480444d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263201133573801002201e01c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6402466ae7002404804003c0384d55cea80089baa0012323333573466e1d40052002200a23333573466e1d40092000200a23263200e33573800a01c01801626aae74dd5000a49035054310032001355009222533500110022213500222330073330080020060010033200135500822225335001100222135002225335333573466e1c005200000c00b13330080070060031333008007335009123330010080030020060031122002122122330010040031220021220012326320033357389210c696e76616c6964206d696e740000349848004448c8c00400488cc00cc008008005";
const docPolicy = { type: "PlutusV2", script: DOC_POLICY_CBOR };
export let DOC_POLICY_ID;

// Your compiled DocVault validator CBOR
const DOC_VAULT_VALIDATOR_CBOR = "59100c010000323232332232332232323232323232323232323232323232332232323232323232323232323233223232223223232533532323232323232533500615335533530145004101f133573892011e646f637661756c743a20706f6f6c207369676e65722072657175697265640001e1533553355003101f133573892120646f637661756c743a206d757374206b656570204e465420696e20696e7075740001e1533553353301a355002222200335007222002101f133573892011e646f637661756c743a206d757374206b656570204e4654206c6f636b65640001e153355335333573466e3cd5400488800cd401c88800c07c078407c4cd5ce24925646f637661756c743a20646174756d206d75737420707265736572766520636c61696d65720001e1533553353232350022235003225335333573466e3c0100080940904cc07c00c0044090d4020888008d54004888008407c4cd5ce2492c646f637661756c743a20646174756d206d75737420707265736572766520646f63206173736574636c6173730001e15335355001222001101f133573892120646f637661756c743a206d757374207365742065786563757465643d547275650001e101e101e101e101e101e15335533530145004101f13357389211e646f637661756c743a20706f6f6c207369676e65722072657175697265640001e15335533535007222001101f133573892011a646f637661756c743a206e6f74206578656375746564207965740001e1533553355003101f133573892120646f637661756c743a206d757374206b656570204e465420696e20696e7075740001e15335333573466e20d4d401c88800888ccc074ccd54c0444800488cd54c058480048d400488cd540e4008cd54c064480048d400488cd540f0008ccd40048cc1052000001223304200200123304100148000004cd54c058480048d400488cd540e4008ccd40048cd54c068480048d400488cd540f4008d5407000400488ccd55405c0880080048cd54c068480048d400488cd540f4008d5406c004004ccd55404807400800540ccc8c8d4004888888888888ccd54c07c4800488d40088888d401088cd400894cd4ccd5cd19b8f017001038037133504900600810082008504100a5007350092220030020014800807807c407c4cd5ce248121646f637661756c743a204e4654206e6f74207061696420746f20636c61696d65720001e101e101e101e153335355001222200213263202f3357389211e646f637661756c743a206d697373696e67206f757470757420646174756d0003421301c001213263203033573892011f646f637661756c743a20657870656374656420696e6c696e6520646174756d0003513253350011302d4988854cd40044008884c0c526533530110032135001223500122223500a2235002222222222222333553022120012235002222253353501822350062232335005233500425335333573466e3c0080040fc0f85400c40f880f88cd401080f894cd4ccd5cd19b8f00200103f03e15003103e153350032153350022133500223350022335002233500223303c00200120412335002204123303c00200122204122233500420412225335333573466e1c01800c11010c54cd4ccd5cd19b870050020440431333573466e1c01000411010c410c410c40f054cd4004840f040f04cd4124018014401541100284c98c80b8cd5ce2481024c6600033133017355335301000221350012200113263202d3357389211b646f637661756c743a206d697373696e67206f776e20696e70757400032222200335004222002135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40a80acd5d0a80619a8150159aba1500b33502a02c35742a014666aa05ceb940b4d5d0a804999aa8173ae502d35742a01066a0540666ae85401cccd540b80d1d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40f9d69aba15002302f357426ae8940088c98c8108cd5ce01f82382009aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a81f3ad35742a004605e6ae84d5d1280111931902119ab9c03f047040135573ca00226ea8004d5d09aba2500223263203e33573807608607826aae7940044dd50009aba1500533502a75c6ae854010ccd540b80c08004d5d0a801999aa8173ae200135742a00460646ae84d5d1280111931901d19ab9c03703f038135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860446ae84d5d1280211931901619ab9c02903102a3333573466e1d40152002212200123333573466e1d40192000212200223263202c335738052062054052602a00c205c2c26aae7940044dd500089aab9d3754002222444666aa600824002a04a66aa600e2400246a0024466aa0540046aa012002666aa600824002446a00444a66a666aa601e240026a01ca02246a002446601400400a00c2006266a052008006a04c00266aa600e2400246a002446466aa056006600200a640026aa05e44a66a00226aa0140064426a00444a66a6601800401022444660040140082600c006004640026aa0504422444a66a00220044426600a004666aa600e2400200a0080022242444600600822424446002008640026aa04a442244a66a0022a04644266a048600800466aa600c2400200800246a002446a0044444444444446666a01a4a0604a0604a0604666aa60262400266a02844a66a004420062002a06046a00244a66aa66a666ae68cdc79a801110011a8021100100f80f0999ab9a3370e6a004440026a0084400203e03c203c26a0680062a06601a4666aa6006240026a004a00a4666aa6008240026a006a00c600e0026644660049101383333343134646530646630623734373638366638303335656536623833303261383762333662323737306634323834633765656634623236003300248938373764353461376166626634376138663739363131363336633664653331633135346230343230333838646362356334353737323231316100001501e501f3500122222222222200412335003223335003220020020013500122001320013550212211222533500113500322001221333500522002300400233355300712001005004001122123300100300211233001225335002100a100100722333573466e3c00800402001c88ccd5cd19b8735001223330050040020014800801c018888c8c8c004014c8004d5408088cd400520002235002225335333573466e3c0080240380344c01c0044c01800cc8004d5407c88cd400520002235002225335333573466e3c00801c03403040044c01800c8c8c8c8cccd5cd19b8735573aa00690001199911091998008020018011bae35742a0066464646666ae68cdc39aab9d5002480008cd5407cdd71aba15002375c6ae84d5d1280111931900e99ab9c01a02201b135573ca00226ea8004d5d0a80118031aba135744a004464c6403266ae7005807805c4d5d1280089aab9e5001137540024646666ae68cdc3a800a4004400a46666ae68cdc3a80124000400a464c6402e66ae700500700540504d55ce9baa0011220021220011232230023758002640026aa030446666aae7c004940548cd4050c010d5d080118019aba2002018232323333573466e1cd55cea8012400046644246600200600460146ae854008c014d5d09aba2500223263201333573802003002226aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea8012400046644246600200600460266ae854008cd4034048d5d09aba2500223263201833573802a03a02c26aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931900d19ab9c01701f018017016135573aa00226ea8004d5d0a80119a804bae357426ae8940088c98c8050cd5ce00880c80909aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5405488c8cccd55cf80112809919a80919aa80a18031aab9d5002300535573ca00460086ae8800c0584d5d080089119191999ab9a3370ea002900011a80a18029aba135573ca00646666ae68cdc3a801240044a028464c6402266ae7003805803c0384d55cea80089baa001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6402266ae7003805803c0380340304d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6401a66ae7002804802c4d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263200b33573801002001226ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201433573802203202402202001e01c01a01826aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900699ab9c00a01200b00a135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c8028cd5ce00380780400389aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900599ab9c008010009008007135573aa00226ea80052401035054310023263200333573892130646f637661756c743a2065787065637465642065786163746c79206f6e6520636f6e74696e75696e67206f7574707574000084984488008488488cc00401000c448848cc00400c00848488c00800c44880044800488cdc00010008891918008009119801980100100081";
const docVaultValidator = { type: "PlutusV2", script: DOC_VAULT_VALIDATOR_CBOR };
let docVaultAddress;

/* =====================================================
   DATUM TYPES (MUST MATCH ON-CHAIN EXACTLY)
===================================================== */

const AssetClass = Data.Object({
  currencySymbol: Data.Bytes(),
  tokenName: Data.Bytes(),
});

// ✅ EXACT MATCH to your Haskell InsuranceDatum
const InsuranceDatum = Data.Object({
  idThreshold: Data.Integer(),
  idClaimerPkh: Data.Bytes(),
  idClaimAmount: Data.Integer(),
  idVotes: Data.Array(Data.Bytes()),
  idDocAsset: AssetClass,
  idExecuted: Data.Boolean(),
});

// ✅ UPDATED PoolDatum (matches new pool validator)
const PoolDatum = Data.Object({
  pdSigners: Data.Array(Data.Bytes()),
  pdThreshold: Data.Integer(),
  pdShareAsset: AssetClass,
  pdTotalShares: Data.Integer(),
});

// ✅ DocVault datum (matches your docvault Haskell)
const DocVaultDatum = Data.Object({
  dvClaimer: Data.Bytes(),
  dvDoc: AssetClass,
  dvExecuted: Data.Boolean(),
});

/* =====================================================
   REDEEMERS
===================================================== */

// ✅ InsuranceAction order:
// PayPremium | SubmitClaim Integer | VoteClaim | ExecuteClaim
const PayPremiumRedeemer = Data.to(new Constr(0, []));
const submitClaimRedeemer = (amt) => Data.to(new Constr(1, [amt]));
const VoteRedeemer = Data.to(new Constr(2, []));
const ExecuteRedeemer = Data.to(new Constr(3, []));

// ✅ UPDATED PoolAction order (matches new validator):
// Deposit | Withdraw Integer | ClaimPayout
const PoolDepositRedeemer = Data.to(new Constr(0, []));
const poolWithdrawRedeemer = (burnedShares) => Data.to(new Constr(1, [burnedShares]));
const ClaimPayoutRedeemer = Data.to(new Constr(2, []));

// Share policy redeemer (Unit)
const UnitRedeemer = Data.to(new Constr(0, []));

// Doc mint redeemer
const DocMintRedeemer = Data.to(new Constr(0, []));

// DocVaultAction = MarkExecuted | RemoveToClaimer
const DocVaultMarkExecuted = Data.to(new Constr(0, []));
const DocVaultRemoveToClaimer = Data.to(new Constr(1, []));

/* =====================================================
   GLOBAL STATE
===================================================== */
export let lucid;
export let walletPkh;

let walletAddress;
let insuranceAddress;
let poolAddress;
let insuranceValidatorHash;
let poolValidatorHash;

/* =====================================================
   UI HELPERS
===================================================== */
function log(msg) {
  const el = document.getElementById("log");
  if (el) el.innerText = msg;
  console.log(msg);
}



async function backendGet(url) {
  const res = await fetch(url, { credentials: "include" });
  if (!res.ok) throw new Error(`Backend request failed: ${res.status}`);
  return res.json();
}

async function backendPost(url, payload) {
  const res = await fetch(url, {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok || data.ok === false) {
    throw new Error(data.error || `Backend request failed: ${res.status}`);
  }
  return data;
}

async function ensureRegisteredWalletOrFail(address) {
  const data = await backendGet(`/wallet_status.php?address=${encodeURIComponent(address)}`);
  if (!data.can_use) {
    alert(`This account is bound to ${data.wallet_address}. Please connect the registered wallet.`);
    throw new Error("Wrong wallet connected");
  }
  return data;
}
window.ensureRegisteredWalletOrFail = ensureRegisteredWalletOrFail;

async function bindWalletToAccount() {
  const challengeResp = await backendGet(`/wallet_challenge.php?address=${encodeURIComponent(walletAddress)}`);
  const challengeHex = new TextEncoder().encode(atob(challengeResp.challenge));
  const signed = await window.cardano.lace.signData(walletAddress, challengeHex);

  const bindResp = await backendPost('/wallet_bind.php', {
    address: walletAddress,
    challenge: challengeResp.challenge,
    signature: signed.signature,
    key: signed.key,
  });

  if (bindResp.first_bind) {
    alert('Wallet linked to your account successfully.');
  }
  return bindResp;
}
window.bindWalletToAccount = bindWalletToAccount;

async function logBackendTx(payload) {
  try {
    await backendPost('/log_tx.php', payload);
  } catch (e) {
    console.warn('tx log failed', e);
  }
}

async function loadStats() {
  try {
    const data = await backendGet('/stats.php');
    const s = data.stats || {};
    const ada = (v) => (Number(v || 0) / 1_000_000).toLocaleString();
    const set = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
    set('stat-total-pool', ada(s.total_pool_deposited));
    set('stat-total-withdrawn', ada(s.total_withdrawn));
    set('stat-claims-submitted', String(s.total_claims_submitted || 0));
    set('stat-claims-executed', String(s.total_claims_executed || 0));
  } catch (e) {
    console.warn('stats load failed', e);
  }
}

async function loadRecentTransactions() {
  try {
    const data = await backendGet('/recent_transactions.php?limit=10');
    const body = document.getElementById('recentTxBody');
    if (!body) return;
    const rows = data.transactions || [];
    body.innerHTML = rows.length
      ? rows.map((r) => `<tr><td>${r.action_type}</td><td>${(r.tx_hash || '').slice(0,18)}...</td><td>${r.amount_lovelace || ''}</td><td>${r.status || ''}</td></tr>`).join('')
      : '<tr><td colspan="4"><em>No transactions yet.</em></td></tr>';
  } catch (e) {
    console.warn('recent transactions failed', e);
  }
}

async function lookupWalletHistory() {
  const input = document.getElementById('historyWalletInput');
  const output = document.getElementById('walletHistoryOutput');
  if (!input || !output) return;
  const address = input.value.trim();
  if (!address) return;

  try {
    const data = await backendGet(`/tx_history.php?address=${encodeURIComponent(address)}`);
    output.textContent = JSON.stringify(data, null, 2);
  } catch (e) {
    output.textContent = `Lookup failed: ${e.message}`;
  }
}
window.lookupWalletHistory = lookupWalletHistory;

async function refreshBackendDashboard() {
  await loadStats();
  await loadRecentTransactions();
}
function ipfsToHttp(url) {
  if (!url) return "";
  return url.startsWith("ipfs://")
    ? `https://ipfs.io/ipfs/${url.slice(7)}`
    : url;
}

/* =====================================================
   PINATA / METADATA
===================================================== */
async function uploadToIPFS(file) {
  if (!PINATA_JWT || PINATA_JWT.includes("<")) {
    throw new Error("Pinata JWT not configured. Move upload to backend or set short-lived token.");
  }

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
    method: "POST",
    headers: { Authorization: `Bearer ${PINATA_JWT}` },
    body: formData,
  });

  if (!res.ok) {
    const t = await res.text().catch(() => "");
    throw new Error(`Pinata upload failed: ${res.status} ${t}`);
  }

  const data = await res.json();
  return data.IpfsHash;
}

async function fetchAssetMetadata(unit) {
  const res = await fetch(`${BLOCKFROST_URL}/assets/${unit}`, {
    headers: { project_id: BLOCKFROST_KEY },
  });

  if (!res.ok) return null;
  const json = await res.json();
  const meta = json.onchain_metadata || {};

  return {
    name: meta.name,
    image: ipfsToHttp(meta.image),
    description: meta.description,
  };
}

/* =====================================================
   MEMBERSHIP (IMPORTANT FOR YOUR INSURANCE VALIDATOR)
   Your validator requires:
   - exactly one signer (done)
   - AND a wallet input that contains the membership NFT
===================================================== */
function membershipUnit() {
  // Your design: tokenName = walletPkh bytes
  return MEMBERSHIP_POLICY_ID + walletPkh;
}

export async function hasMembershipNFT() {
  const unit = membershipUnit();
  const utxos = await lucid.wallet.getUtxos();
  return utxos.some((u) => (u.assets?.[unit] ?? 0n) >= 1n);
}

async function pickMembershipUtxo() {
  const unit = membershipUnit();
  const utxos = await lucid.wallet.getUtxos();
  const u = utxos.find((x) => (x.assets?.[unit] ?? 0n) >= 1n);
  if (!u) throw new Error("Membership UTxO not found. Your insurance validator requires it in tx inputs.");
  return u;
}

/* =====================================================
   POOL UTXO HELPERS
===================================================== */
async function getPoolUtxo() {
  const utxos = await lucid.utxosAt(poolAddress);
  if (utxos.length === 0) return null;
  if (utxos.length > 1) throw new Error("Pool invariant broken: multiple pool UTXOs");
  return utxos[0];
}

async function blockfrostGetAssetSupply(assetUnit) {
  const res = await fetch(`${BLOCKFROST_URL}/assets/${assetUnit}`, {
    headers: { project_id: BLOCKFROST_KEY },
  });
  if (!res.ok) {
    const t = await res.text().catch(() => "");
    throw new Error(`Blockfrost asset fetch failed (${res.status}): ${t}`);
  }
  const json = await res.json();
  return BigInt(json.quantity);
}

async function getShareBalance() {
  const utxos = await lucid.wallet.getUtxos();
  let bal = 0n;
  for (const u of utxos) bal += (u.assets?.[SHARE_UNIT] ?? 0n);
  return bal;
}

async function getTotalSharesInCirculation() {
  return await blockfrostGetAssetSupply(SHARE_UNIT);
}

/* =====================================================
   DOCVAULT “REVOCATION LIST” CHECK
===================================================== */
async function isWalletRevokedFromWithdrawal() {
  const utxos = await lucid.utxosAt(docVaultAddress);
  for (const u of utxos) {
    if (!u.datum) continue;
    try {
      const dv = Data.from(u.datum, DocVaultDatum);
      if (dv.dvClaimer === walletPkh) return true;
    } catch {}
  }
  return false;
}

/* =====================================================
   UI: MEMBERSHIP + SHARES
===================================================== */
export async function refreshMembershipUI() {
  const ok = await hasMembershipNFT();

  document.getElementById("membership")?.classList.toggle("hidden", ok);
  document.getElementById("protocol")?.classList.toggle("hidden", !ok);

  log(ok ? "Membership verified ✔️ Access granted" : "Membership required ❌");

  if (ok) {
    await loadClaims();
    await refreshSharesUI();
  }
}

async function refreshSharesUI() {
  const el = document.getElementById("shareBalance");
  if (!el) return;

  try {
    const bal = await getShareBalance();
    el.innerText = `${bal.toString()} POOLSHARE`;
  } catch {
    el.innerText = "--";
  }
}

/* =====================================================
   CLAIMS: LOAD + RENDER
===================================================== */
async function loadClaims() {
  try {
    const utxos = await lucid.utxosAt(insuranceAddress);

    const pending = [];
    const ready = [];
    const executed = [];

    for (const utxo of utxos) {
      if (!utxo.datum) continue;

      let d;
      try {
        d = Data.from(utxo.datum, InsuranceDatum);
      } catch {
        continue;
      }

      const docUnit = d.idDocAsset.currencySymbol + d.idDocAsset.tokenName;

      const claim = {
        utxo,
        datum: d,
        claimer: d.idClaimerPkh,
        amountAda: Number(d.idClaimAmount) / 1_000_000,
        threshold: Number(d.idThreshold),
        votes: d.idVotes.length,
        hasVoted: d.idVotes.some((v) => v === walletPkh),
        metThreshold: d.idVotes.length >= Number(d.idThreshold),
        executed: d.idExecuted,
        docUnit,
      };

      if (claim.executed) executed.push(claim);
      else if (claim.metThreshold) ready.push(claim);
      else pending.push(claim);
    }

    await renderClaims(pending, ready, executed);
  } catch (e) {
    console.error(e);
    log("Failed to load claims: " + (e?.message ?? e));
  }
}

async function renderClaims(forVoting, forExecution, executed) {
  const votingSection = document.getElementById("claimsForVoting");
  const executionSection = document.getElementById("claimsForExecution");
  const executedSection = document.getElementById("claimsExecuted"); // add <div id="claimsExecuted"></div>

  async function claimCardHtml(claim, idx, mode) {
    const meta = await fetchAssetMetadata(claim.docUnit);
    const url = meta?.image || "";

    const docLink = url
      ? `<a class="nft-link" href="${url}" target="_blank" rel="noopener noreferrer">🔍 View Claim Doc</a>`
      : `<span class="muted">No doc preview</span>`;

    const claimerShort = claim.claimer ? (claim.claimer.slice(0, 16) + "…") : "Unknown";

    const header =
      mode === "exec" ? `✅ Claim #${idx + 1}` :
      mode === "done" ? `🧾 Claim #${idx + 1}` :
      `Claim #${idx + 1}`;

    const btn =
      mode === "vote"
        ? `<button class="white" onclick="voteForClaim(${idx})" ${claim.hasVoted ? "disabled" : ""}>
             ${claim.hasVoted ? "✓ Voted" : "Vote"}
           </button>`
        : mode === "exec"
        ? `<button class="red" onclick="executeClaimByIndex(${idx})">Execute</button>`
        : `<button class="white" disabled>Executed</button>`;

    return `
      <div class="claim-card ${mode === "exec" ? "execution" : ""}">
        <div class="claim-info">
          <strong>${header}</strong><br>
          Amount: <strong>${claim.amountAda} ADA</strong><br>
          Votes: <strong>${claim.votes}/${claim.threshold}</strong>${mode === "exec" ? " (Passed)" : ""}<br>
          Claimer: <code>${claimerShort}</code><br>
          ${meta?.name ? `<div class="muted">Doc: ${meta.name}</div>` : ""}
          ${docLink}
        </div>
        ${btn}
      </div>
    `;
  }

  if (votingSection) {
    if (forVoting.length === 0) votingSection.innerHTML = "<p><em>No claims pending votes</em></p>";
    else {
      const html = await Promise.all(forVoting.map((c, i) => claimCardHtml(c, i, "vote")));
      votingSection.innerHTML = `<div class="claims-grid">${html.join("")}</div>`;
    }
  }

  if (executionSection) {
    if (forExecution.length === 0) executionSection.innerHTML = "<p><em>No claims ready for execution</em></p>";
    else {
      const html = await Promise.all(forExecution.map((c, i) => claimCardHtml(c, i, "exec")));
      executionSection.innerHTML = `<div class="claims-grid">${html.join("")}</div>`;
    }
  }

  if (executedSection) {
    if (executed.length === 0) executedSection.innerHTML = "<p><em>No executed claims</em></p>";
    else {
      const html = await Promise.all(executed.map((c, i) => claimCardHtml(c, i, "done")));
      executedSection.innerHTML = `<div class="claims-grid">${html.join("")}</div>`;
    }
  }

  window.claimsForVoting = forVoting;
  window.claimsForExecution = forExecution;
  window.claimsExecuted = executed;
}

/* =====================================================
   INIT
===================================================== */
async function init() {
  lucid = await Lucid.new(new Blockfrost(BLOCKFROST_URL, BLOCKFROST_KEY), NETWORK);

  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();
  walletPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  MEMBERSHIP_POLICY_ID = lucid.utils.mintingPolicyToId(membershipPolicy);

  insuranceAddress = lucid.utils.validatorToAddress(insuranceValidator);

  insuranceValidatorHash =
  lucid.utils.validatorToScriptHash(insuranceValidator);

  console.log("Insurance validator hash:", insuranceValidatorHash);

  poolAddress = lucid.utils.validatorToAddress(poolValidator);
  poolValidatorHash = lucid.utils.validatorToScriptHash(poolValidator);
  console.log("poolValidatorHash:", poolValidatorHash);

  SHARE_POLICY_ID = lucid.utils.mintingPolicyToId(sharePolicy);
  SHARE_UNIT = SHARE_POLICY_ID + SHARE_TN_HEX;

  DOC_POLICY_ID = lucid.utils.mintingPolicyToId(docPolicy);
  docVaultAddress = lucid.utils.validatorToAddress(docVaultValidator);

  console.log("insuranceAddress", insuranceAddress);
  console.log("poolAddress", poolAddress);
  console.log("docVaultAddress", docVaultAddress);
  console.log("DOC_POLICY_ID", DOC_POLICY_ID);
  console.log("MEMBERSHIP_POLICY_ID", MEMBERSHIP_POLICY_ID);

  await ensureRegisteredWalletOrFail(walletAddress);
  await bindWalletToAccount();
  await refreshMembershipUI();
  await refreshBackendDashboard();
}

window.init = init;

/* =====================================================
   POOL DEPOSIT (MINT SHARES)
===================================================== */
async function depositToPool() {
  if (!(await hasMembershipNFT())) throw new Error("No membership");

  const ada = BigInt(document.getElementById("depositAmount").value);
  if (ada <= 0n) throw new Error("Enter a valid deposit amount");

  const amount = ada * 1_000_000n;
  const poolUtxo = await getPoolUtxo();

  let tx = lucid.newTx();

  // Share assetclass for datum
  const shareAsset = { currencySymbol: SHARE_POLICY_ID, tokenName: SHARE_TN_HEX };

  if (!poolUtxo) {
    // bootstrap pool
    const addr1 =
      "addr_test1qqe5zn0qmu9hga5xlqp4ae4cxq4g0vmtyac0g2zv0mh5kfhsn2ld9h4unte6gjsml94j9rsk8kktpvf0dqznl629esdsk76wfv";
    const addr2 =
      "addr_test1qpma2jn6l0684rmevytrd3k7x8q4fvzzqwydedwy2aezzxjacmj4jllasdrpk6rlyl5dhsg0wne5nssnt68z6s5f4x7s66s08j";

    const pkh1 = lucid.utils.getAddressDetails(addr1).paymentCredential.hash;
    const pkh2 = lucid.utils.getAddressDetails(addr2).paymentCredential.hash;

    // ✅ NEW datum fields included
    const datum = Data.to(
      {
        pdSigners: [pkh1, pkh2],
        pdThreshold: 1n,
        pdShareAsset: shareAsset,
        pdTotalShares: 0n,
      },
      PoolDatum
    );

    tx = tx.payToContract(poolAddress, { inline: datum }, { lovelace: amount });

    const completed = await tx.addSignerKey(walletPkh).complete();
    const initTxHash = await (await completed.sign().complete()).submit();

    await logBackendTx({
      tx_hash: initTxHash,
      action_type: "deposit_pool",
      actor_wallet_address: walletAddress,
      amount_lovelace: amount.toString(),
      status: "submitted"
    });

    log("✅ Pool initialized. Shares minting starts from NEXT deposit.");
    await refreshSharesUI();
    return;
  }

  const poolDatum = Data.from(
    poolUtxo.datum ?? (await lucid.datumOf(poolUtxo)),
    PoolDatum
  );

  const existing = poolUtxo.assets.lovelace;
  const newPoolValue = existing + amount;

  // 1 share per 1 ADA
  const sharesToMint = ada;

  // ✅ MUST UPDATE pdTotalShares on deposit
  const newPoolDatum = {
    ...poolDatum,
    // keep pdSigners/pdThreshold/pdShareAsset the same, just update totalShares
    pdTotalShares: BigInt(poolDatum.pdTotalShares) + sharesToMint,
  };

  tx = tx
    // ✅ NEW redeemer for Deposit
    .collectFrom([poolUtxo], PoolDepositRedeemer)
    .attachSpendingValidator(poolValidator)

    // shares minted by minting policy
    .mintAssets({ [SHARE_UNIT]: sharesToMint }, UnitRedeemer)
    .attachMintingPolicy(sharePolicy)

    // ✅ pay back to pool with UPDATED datum + updated ADA
    .payToContract(
      poolAddress,
      { inline: Data.to(newPoolDatum, PoolDatum) },
      { lovelace: newPoolValue }
    )
    .addSignerKey(walletPkh);

  const completed = await tx.complete();
  const txHash = await (await completed.sign().complete()).submit();

  await logBackendTx({
    tx_hash: txHash,
    action_type: "deposit_pool",
    actor_wallet_address: walletAddress,
    amount_lovelace: amount.toString(),
    status: "submitted"
  });

  log(`✅ Deposit successful. Minted ${sharesToMint.toString()} POOLSHARE`);
  await refreshSharesUI();
  await loadClaims();
}

window.depositToPool = depositToPool;

/* =====================================================
   SUBMIT CLAIM (UPLOAD + MINT DOC NFT + LOCK WITH CLAIM)
===================================================== */
export async function submitClaim() {
  if (!(await hasMembershipNFT())) throw new Error("No membership");

  // offchain gating
  const myShares = await getShareBalance();
  if (myShares < 20n) throw new Error("Need at least 20 POOLSHARE before submitting a claim.");

  const claimAmount = BigInt(document.getElementById("claimAmount").value) * 1_000_000n;
  if (claimAmount <= 0n) throw new Error("Enter a valid claim amount.");

  const threshold = 2n;

  // <input type="file" id="claimDocUpload" />
  const fileInput = document.getElementById("claimDocUpload");
  if (!fileInput?.files?.length) throw new Error("Upload a claim proof document.");

  const file = fileInput.files[0];

  // tokenName = sha256(file)
  const arrayBuffer = await file.arrayBuffer();
  const hash = await crypto.subtle.digest("SHA-256", arrayBuffer);
  const tokenNameHex = Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, "0")).join("");

  const docUnit = DOC_POLICY_ID + tokenNameHex;

  // upload to IPFS
  const cid = await uploadToIPFS(file);
  const ipfsUrl = `ipfs://${cid}`;
  const httpUrl = `https://ipfs.io/ipfs/${cid}`;

  // CIP-25 metadata (721)
  const metadata = {
    721: {
      [DOC_POLICY_ID]: {
        [tokenNameHex]: {
          name: "Claim Proof",
          image: ipfsUrl,
          mediaType: file.type,
          files: [{ name: "Claim Proof Document", mediaType: file.type }],
          description: "Proof attached to insurance claim",
        },
      },
    },
  };

  // datum matches Haskell exactly
  const datum = Data.to(
    {
      idThreshold: threshold,
      idClaimerPkh: walletPkh,
      idClaimAmount: claimAmount,
      idVotes: [],
      idDocAsset: { currencySymbol: DOC_POLICY_ID, tokenName: tokenNameHex },
      idExecuted: false,
    },
    InsuranceDatum
  );

  // NOTE: we are not spending an existing insurance UTxO here,
  // so your on-chain SubmitClaim redeemer is not being used.
  // This pattern still works because it just creates a claim UTxO.
  const tx = await lucid
    .newTx()
    .mintAssets({ [docUnit]: 1n }, DocMintRedeemer)
    .attachMintingPolicy(docPolicy)
    .attachMetadata(721, metadata[721])
    .payToContract(insuranceAddress, { inline: datum }, { lovelace: 2_000_000n, [docUnit]: 1n })
    .addSignerKey(walletPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  await logBackendTx({
    tx_hash: txHash,
    action_type: "submit_claim",
    reference_id: docUnit,
    actor_wallet_address: walletAddress,
    amount_lovelace: claimAmount.toString(),
    asset_unit: docUnit,
    status: "submitted"
  });

  log("✅ Claim submitted with doc. TX: " + txHash + " | Verify: " + httpUrl);
  await loadClaims();
  await refreshBackendDashboard();
}

window.submitClaim = submitClaim;

/* =====================================================
   VOTE ON CLAIM
   IMPORTANT: must include membership UTxO in inputs
===================================================== */
async function voteForClaim(index) {
  if (!(await hasMembershipNFT())) throw new Error("No membership");

  const claim = window.claimsForVoting[index];
  if (!claim) throw new Error("Claim not found");

  const u = claim.utxo;
  const d = claim.datum;

  if (d.idExecuted) throw new Error("Claim already executed.");
  if (d.idVotes.some((v) => v === walletPkh)) throw new Error("Already voted.");

  const membershipUtxo = await pickMembershipUtxo();

  const updatedDatum = Data.to(
    { ...d, idVotes: [...d.idVotes, walletPkh] },
    InsuranceDatum
  );

  const tx = await lucid
    .newTx()
    // membership UTxO MUST be in txInfoInputs
    .collectFrom([u], VoteRedeemer)
    .attachSpendingValidator(insuranceValidator)
    // preserve all assets (includes doc NFT)
    .payToContract(insuranceAddress, { inline: updatedDatum }, u.assets)
    // exactly one signer
    .addSignerKey(walletPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  await logBackendTx({
    tx_hash: txHash,
    action_type: "vote_claim",
    reference_id: String(index),
    actor_wallet_address: walletAddress,
    status: "submitted"
  });

  log("✅ Vote submitted");
  await loadClaims();
}

window.voteForClaim = voteForClaim;

/* =====================================================
   WITHDRAW (BLOCK IF REVOKED BY DOCVAULT)
===================================================== */
async function withdrawFromPool() {
  if (!(await hasMembershipNFT())) throw new Error("No membership");

  const revoked = await isWalletRevokedFromWithdrawal();
  if (revoked) throw new Error("Withdrawal revoked: this wallet has executed coverage/claims.");

  const shares = BigInt(document.getElementById("withdrawShares").value);
  if (shares <= 0n) throw new Error("Enter shares to withdraw");

  const myShares = await getShareBalance();
  if (shares > myShares) throw new Error("Not enough shares");

  const poolUtxo = await getPoolUtxo();
  if (!poolUtxo) throw new Error("Pool not initialized");

  const poolDatum = Data.from(
    poolUtxo.datum ?? (await lucid.datumOf(poolUtxo)),
    PoolDatum
  );

  const poolAda = poolUtxo.assets.lovelace;

  // ✅ Use on-chain tracked total shares (validator uses pdTotalShares dat)
  const totalShares = BigInt(poolDatum.pdTotalShares);
  if (totalShares <= 0n) throw new Error("Pool total shares is 0");
  if (shares > totalShares) throw new Error("Withdraw exceeds pool total shares");

  const withdrawLovelace = (shares * poolAda) / totalShares;
  if (withdrawLovelace <= 0n) throw new Error("Withdrawal too small");

  const remainder = poolAda - withdrawLovelace;

  // ✅ Update datum: decrease total shares
  const newPoolDatum = {
    ...poolDatum,
    pdTotalShares: totalShares - shares,
  };

  const redeemer = poolWithdrawRedeemer(shares);

  const tx = await lucid
    .newTx()
    // ✅ spend pool with Withdraw redeemer (NOT PayoutRedeemer)
    .collectFrom([poolUtxo], redeemer)
    .attachSpendingValidator(poolValidator)

    // ✅ burn shares (validator checks mint == -burnedShares)
    .mintAssets({ [SHARE_UNIT]: -shares }, UnitRedeemer)
    .attachMintingPolicy(sharePolicy)

    // ✅ pay wallet
    .payToAddress(walletAddress, { lovelace: withdrawLovelace })

    // ✅ keep pool alive with updated datum + remainder
    .payToContract(
      poolAddress,
      { inline: Data.to(newPoolDatum, PoolDatum) },
      { lovelace: remainder }
    )

    .addSignerKey(walletPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  await logBackendTx({
    tx_hash: txHash,
    action_type: "withdraw_shares",
    actor_wallet_address: walletAddress,
    amount_lovelace: withdrawLovelace.toString(),
    asset_unit: SHARE_UNIT,
    status: "submitted"
  });

  log(`✅ Withdraw successful. Burned ${shares.toString()} shares. TX: ${txHash}`);
  await refreshSharesUI();
  await refreshBackendDashboard();
}

window.withdrawFromPool = withdrawFromPool;

/* =====================================================
   EXECUTE CLAIM (INSURANCE + POOL PAYOUT + DOCVAULT)
   - MUST keep exactly one signer (insurance rule)
   - MUST have pool pdThreshold = 1 (otherwise pool wants more signers)
   - We move doc NFT from claim UTxO -> docVault output
   - Insurance validator only checks claimer got paid and threshold met
===================================================== */
async function executeClaimByIndex(index) {
  if (!(await hasMembershipNFT())) throw new Error("No membership");

  const claim = window.claimsForExecution[index];
  if (!claim) throw new Error("Claim not found");

  const claimUtxo = claim.utxo;
  const poolUtxo = await getPoolUtxo();
  if (!poolUtxo) throw new Error("No pool funds available");

  const membershipUtxo = await pickMembershipUtxo();

  const claimDatum = claim.datum;
  if (claimDatum.idExecuted) throw new Error("Already executed");

  const poolDatum = Data.from(
    poolUtxo.datum ?? (await lucid.datumOf(poolUtxo)),
    PoolDatum
  );

  // ✅ because INSURANCE requires exactly one signer, pool must allow claim payout with 1 signer too
  // Restrict executor to allowed pdSigners (your hardcoded signers)
  const isSigner = poolDatum.pdSigners.some((s) => s === walletPkh);
  if (!isSigner) throw new Error("❌ You are not an authorized pool signer!");

  // Optional safety: if your on-chain pool uses pdThreshold for ClaimPayout, keep it 1
  if (BigInt(poolDatum.pdThreshold) !== 1n) {
    throw new Error("Pool pdThreshold must be 1 for claim execution, because insurance requires exactly one signer.");
  }

  const poolAda = poolUtxo.assets.lovelace;
  const claimLovelace = BigInt(claimDatum.idClaimAmount);

  if (claimLovelace > poolAda) throw new Error("Pool has insufficient funds");

  const remainder = poolAda - claimLovelace;

  const doc = claimDatum.idDocAsset;
  const docUnit = doc.currencySymbol + doc.tokenName;

  // executed record for UI/history (no NFT here, NFT moves to DocVault)
  const executedClaimDatum = Data.to(
    { ...claimDatum, idExecuted: true },
    InsuranceDatum
  );

  const dvDatum = Data.to(
    { dvClaimer: claimDatum.idClaimerPkh, dvDoc: doc, dvExecuted: true },
    DocVaultDatum
  );

  const claimerAddr = lucid.utils.credentialToAddress({
    type: "Key",
    hash: claimDatum.idClaimerPkh,
  });

  const tx = await lucid
    .newTx()
    // membership UTxO in inputs (aligns with your membership scheme)
    .collectFrom([membershipUtxo])

    // spend insurance claim UTxO
    .collectFrom([claimUtxo], ExecuteRedeemer)
    .attachSpendingValidator(insuranceValidator)

    // ✅ spend pool UTxO using ClaimPayout (NOT PayoutRedeemer)
    .collectFrom([poolUtxo], ClaimPayoutRedeemer)
    .attachSpendingValidator(poolValidator)

    // pay claimer (insurance checks this)
    .payToAddress(claimerAddr, { lovelace: claimLovelace })

    // move doc NFT to DocVault
    .payToContract(
      docVaultAddress,
      { inline: dvDatum },
      { lovelace: 2_000_000n, [docUnit]: 1n }
    )

    // keep pool alive (datum unchanged; totalShares unchanged)
    .payToContract(
      poolAddress,
      { inline: Data.to(poolDatum, PoolDatum) },
      { lovelace: remainder }
    )

    // keep executed record at insurance (no NFT)
    .payToContract(
      insuranceAddress,
      { inline: executedClaimDatum },
      { lovelace: 2_000_000n }
    )

    // ✅ exactly one signer
    .addSignerKey(walletPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  await logBackendTx({
    tx_hash: txHash,
    action_type: "execute_claim",
    reference_id: docUnit,
    actor_wallet_address: walletAddress,
    counterparty_wallet_address: claimerAddr,
    amount_lovelace: claimLovelace.toString(),
    status: "submitted"
  });

  log("✅ Claim executed. TX: " + txHash);
  await loadClaims();
  await refreshBackendDashboard();
}

window.executeClaimByIndex = executeClaimByIndex;

/* =====================================================
   DOCVAULT ADMIN ACTIONS (OPTIONAL)
===================================================== 
async function docVaultMarkExecutedByIndex(index) {
  const utxos = await lucid.utxosAt(docVaultAddress);
  const u = utxos[index];
  if (!u?.datum) throw new Error("DocVault UTxO not found");

  const dv = Data.from(u.datum, DocVaultDatum);
  const docUnit = dv.dvDoc.currencySymbol + dv.dvDoc.tokenName;

  const newDv = Data.to({ ...dv, dvExecuted: true }, DocVaultDatum);

  const tx = await lucid
    .newTx()
    .collectFrom([u], DocVaultMarkExecuted)
    .attachSpendingValidator(docVaultValidator)
    .payToContract(
      docVaultAddress,
      { inline: newDv },
      { lovelace: u.assets.lovelace ?? 2_000_000n, [docUnit]: 1n }
    )
    .addSignerKey(walletPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();
  log("✅ DocVault marked executed. TX: " + txHash);
}
window.docVaultMarkExecutedByIndex = docVaultMarkExecutedByIndex;

async function docVaultRemoveToClaimerByIndex(index) {
  const utxos = await lucid.utxosAt(docVaultAddress);
  const u = utxos[index];
  if (!u?.datum) throw new Error("DocVault UTxO not found");

  const dv = Data.from(u.datum, DocVaultDatum);
  const docUnit = dv.dvDoc.currencySymbol + dv.dvDoc.tokenName;

  const claimerAddr = lucid.utils.credentialToAddress({
    type: "Key",
    hash: dv.dvClaimer,
  });

  const tx = await lucid
    .newTx()
    .collectFrom([u], DocVaultRemoveToClaimer)
    .attachSpendingValidator(docVaultValidator)
    .payToAddress(claimerAddr, { lovelace: 2_000_000n, [docUnit]: 1n })
    .addSignerKey(walletPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();
  log("✅ DocVault removed doc to claimer. TX: " + txHash);
}
window.docVaultRemoveToClaimerByIndex = docVaultRemoveToClaimerByIndex;

/* =====================================================
   LEGACY BUTTONS
===================================================== */
export async function voteClaim() {
  if (window.claimsForVoting?.length) return voteForClaim(0);
  throw new Error("No claims available for voting");
}

export async function executeClaim() {
  if (window.claimsForExecution?.length) return executeClaimByIndex(0);
  throw new Error("No claims ready for execution");
}

window.voteClaim = voteClaim;
window.executeClaim = executeClaim;

/* =====================================================
   CONNECT BUTTON
===================================================== */
document.getElementById("connect")?.addEventListener("click", init);
