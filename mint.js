import {
  Constr,
  Data,
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

import {
  lucid,
  walletPkh,
  MEMBERSHIP_POLICY_ID,
  refreshMembershipUI
} from "./depo.js";

/* =====================================================
   POLICY
===================================================== */

const MEMBERSHIP_POLICY_CBOR = "59092501000032323233223232323232323232323322323322323232323232323232223232533532325335533553353008355001222222222222008101e22135002222533500415335333573466e3c00cd401c88cccd40048c98c8098cd5ce2481024c680002920012326320263357389201024c68000292326320263357389201024c680002902402315335333573466e1c005200202402315335333573466e3c009221000240231023102410231023221025101f1335738921196d757374206d696e742065786163746c79206f6e65204e46540001e1533553353008355001222222222222008101e22135002222533500413235001222222222222533533355301912001321233001225335002210031001002502525335333573466e3c0400040c80c44d409c00454098010840c840c14018884094407c4cd5ce24811d6d757374206265207369676e656420627920746f6b656e206f776e65720001e101e135001220023333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4060064d5d0a80619a80c00c9aba1500b33501801a35742a014666aa038eb9406cd5d0a804999aa80e3ae501b35742a01066a03004a6ae85401cccd54070099d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40c1d69aba150023031357426ae8940088c98c80cccd5ce01a81b01889aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8183ad35742a00460626ae84d5d1280111931901999ab9c035036031135573ca00226ea8004d5d09aba2500223263202f33573806206405a26aae7940044dd50009aba1500533501875c6ae854010ccd540700888004d5d0a801999aa80e3ae200135742a00460486ae84d5d1280111931901599ab9c02d02e029135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00460286ae84d5d1280111931900e99ab9c01f02001b101f16135573ca00226ea8004c8004d5406c88448894cd40044d400c88004884ccd401488008c010008ccd54c01c480040140100048cc0094028004c8004d540648894cd40044008884d400888cc01cccc02000801800400cc8004d5406088894cd40044008884d4008894cd4ccd5cd19b87001480000740704ccc02001c01800c4ccc02001ccd403848ccc00402000c00801800c48c88c008dd6000990009aa80c111999aab9f0012500a233500930043574200460066ae880080648c8c8cccd5cd19b8735573aa004900011991091980080180118071aba150023005357426ae8940088c98c8058cd5ce00c00c80a09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180b9aba1500233500f016357426ae8940088c98c806ccd5ce00e80f00c89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403a66ae7007c08006c0680644d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201733573803203402a26ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355015223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301713574200222440042442446600200800624464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900919ab9c01401501000f135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01201300e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00e00f00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00600680409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a80b00880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae7003803c0280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801601800e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7003003402001c0184d55cea80089baa0012323333573466e1d40052002200623333573466e1d40092000200623263200633573801001200800626aae74dd5000a4c2440042440029210350543100120011123230010012233003300200200101";

const membershipPolicy = {
  type: "PlutusV2",
  script: MEMBERSHIP_POLICY_CBOR,
};

const redeemer = Data.to(new Constr(0, []));

/* =====================================================
   MINT
===================================================== */

export async function mintMembership() {
//   const membershipPolicyId = lucid.utils.mintingPolicyToId(membershipPolicy);
  const unit = MEMBERSHIP_POLICY_ID + walletPkh;

  const utxos = await lucid.wallet.getUtxos();
  if (utxos.some(u => u.assets[unit] === 1n)) {
    return alert("Already a member");
  }

  const tx = await lucid
    .newTx()
    .mintAssets({ [unit]: 1n }, redeemer)
    .attachMintingPolicy(membershipPolicy)
    .addSignerKey(walletPkh)
    .complete();

  await (await tx.sign().complete()).submit();

  await refreshMembershipUI(); // ðŸ”¥ THIS FIXES YOUR PROBLEM
}

window.mintMembership = mintMembership;
